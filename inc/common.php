<?php 
function us_states(){
    return array(     'Alabama'=>'Alabama',     'Alaska'=>'Alaska',     'Arizona'=>'Arizona',     'Arkansas'=>'Arkansas',     'California'=>'California',     'Colorado'=>'Colorado',     'Connecticut'=>'Connecticut',     'Delaware'=>'Delaware',     'District of Columbia'=>'District of Columbia',     'Florida'=>'Florida',     'Georgia'=>'Georgia',     'Hawaii'=>'Hawaii',     'Idaho'=>'Idaho',     'Illinois'=>'Illinois',     'Indiana'=>'Indiana',     'Iowa'=>'Iowa',     'Kansas'=>'Kansas',     'Kentucky'=>'Kentucky',     'Louisiana'=>'Louisiana',     'Maine'=>'Maine',     'Maryland'=>'Maryland',     'Massachusetts'=>'Massachusetts',     'Michigan'=>'Michigan',     'Minnesota'=>'Minnesota',     'Mississippi'=>'Mississippi',     'Missouri'=>'Missouri',     'Montana'=>'Montana',     'Nebraska'=>'Nebraska',     'Nevada'=>'Nevada',     'New Hampshire'=>'New Hampshire',     'New Jersey'=>'New Jersey',     'New Mexico'=>'New Mexico',     'New York'=>'New York',     'North Carolina'=>'North Carolina',     'North Dakota'=>'North Dakota',     'Ohio'=>'Ohio',     'Oklahoma'=>'Oklahoma',     'Oregon'=>'Oregon',     'Pennsylvania'=>'Pennsylvania',     'Rhode Island'=>'Rhode Island',     'South Carolina'=>'South Carolina',     'South Dakota'=>'South Dakota',     'Tennessee'=>'Tennessee',     'Texas'=>'Texas',     'Utah'=>'Utah',     'Vermont'=>'Vermont',     'Virginia'=>'Virginia',     'Washington'=>'Washington',     'West Virginia'=>'West Virginia',     'Wisconsin'=>'Wisconsin',     'Wyoming'=>'Wyoming', );
}

function countries_array(){
    return  array     (         'US' => 'United States',         'GB' => 'United Kingdom',         'AF' => 'Afghanistan',         'AX' => 'Aland Islands',         'AL' => 'Albania',         'DZ' => 'Algeria',         'AS' => 'American Samoa',         'AD' => 'Andorra',         'AO' => 'Angola',         'AI' => 'Anguilla',         'AQ' => 'Antarctica',         'AG' => 'Antigua And Barbuda',         'AR' => 'Argentina',         'AM' => 'Armenia',         'AW' => 'Aruba',         'AU' => 'Australia',         'AT' => 'Austria',         'AZ' => 'Azerbaijan',         'BS' => 'Bahamas',         'BH' => 'Bahrain',         'BD' => 'Bangladesh',         'BB' => 'Barbados',         'BY' => 'Belarus',         'BE' => 'Belgium',         'BZ' => 'Belize',         'BJ' => 'Benin',         'BM' => 'Bermuda',         'BT' => 'Bhutan',         'BO' => 'Bolivia',         'BA' => 'Bosnia And Herzegovina',         'BW' => 'Botswana',         'BV' => 'Bouvet Island',         'BR' => 'Brazil',         'IO' => 'British Indian Ocean Territory',         'BN' => 'Brunei Darussalam',         'BG' => 'Bulgaria',         'BF' => 'Burkina Faso',         'BI' => 'Burundi',         'KH' => 'Cambodia',         'CM' => 'Cameroon',         'CA' => 'Canada',         'CV' => 'Cape Verde',         'KY' => 'Cayman Islands',         'CF' => 'Central African Republic',         'TD' => 'Chad',         'CL' => 'Chile',         'CN' => 'China',         'CX' => 'Christmas Island',         'CC' => 'Cocos (Keeling) Islands',         'CO' => 'Colombia',         'KM' => 'Comoros',         'CG' => 'Congo',         'CD' => 'Congo, Democratic Republic',         'CK' => 'Cook Islands',         'CR' => 'Costa Rica',         'CI' => 'Cote D\'Ivoire',         'HR' => 'Croatia',         'CU' => 'Cuba',         'CY' => 'Cyprus',         'CZ' => 'Czech Republic',         'DK' => 'Denmark',         'DJ' => 'Djibouti',         'DM' => 'Dominica',         'DO' => 'Dominican Republic',         'EC' => 'Ecuador',         'EG' => 'Egypt',         'SV' => 'El Salvador',         'GQ' => 'Equatorial Guinea',         'ER' => 'Eritrea',         'EE' => 'Estonia',         'ET' => 'Ethiopia',         'FK' => 'Falkland Islands (Malvinas)',         'FO' => 'Faroe Islands',         'FJ' => 'Fiji',         'FI' => 'Finland',         'FR' => 'France',         'GF' => 'French Guiana',         'PF' => 'French Polynesia',         'TF' => 'French Southern Territories',         'GA' => 'Gabon',         'GM' => 'Gambia',         'GE' => 'Georgia',         'DE' => 'Germany',         'GH' => 'Ghana',         'GI' => 'Gibraltar',         'GR' => 'Greece',         'GL' => 'Greenland',         'GD' => 'Grenada',         'GP' => 'Guadeloupe',         'GU' => 'Guam',         'GT' => 'Guatemala',         'GG' => 'Guernsey',         'GN' => 'Guinea',         'GW' => 'Guinea-Bissau',         'GY' => 'Guyana',         'HT' => 'Haiti',         'HM' => 'Heard Island & Mcdonald Islands',         'VA' => 'Holy See (Vatican City State)',         'HN' => 'Honduras',         'HK' => 'Hong Kong',         'HU' => 'Hungary',         'IS' => 'Iceland',         'IN' => 'India',         'ID' => 'Indonesia',         'IR' => 'Iran, Islamic Republic Of',         'IQ' => 'Iraq',         'IE' => 'Ireland',         'IM' => 'Isle Of Man',         'IT' => 'Italy',         'JM' => 'Jamaica',         'JP' => 'Japan',         'JE' => 'Jersey',         'JO' => 'Jordan',         'KZ' => 'Kazakhstan',         'KE' => 'Kenya',         'KI' => 'Kiribati',         'KR' => 'Korea',         'KW' => 'Kuwait',         'KG' => 'Kyrgyzstan',         'LA' => 'Lao People\'s Democratic Republic',         'LV' => 'Latvia',         'LB' => 'Lebanon',         'LS' => 'Lesotho',         'LR' => 'Liberia',         'LY' => 'Libyan Arab Jamahiriya',         'LI' => 'Liechtenstein',         'LT' => 'Lithuania',         'LU' => 'Luxembourg',         'MO' => 'Macao',         'MK' => 'Macedonia',         'MG' => 'Madagascar',         'MW' => 'Malawi',         'MY' => 'Malaysia',         'MV' => 'Maldives',         'ML' => 'Mali',         'MT' => 'Malta',         'MH' => 'Marshall Islands',         'MQ' => 'Martinique',         'MR' => 'Mauritania',         'MU' => 'Mauritius',         'YT' => 'Mayotte',         'MX' => 'Mexico',         'FM' => 'Micronesia, Federated States Of',         'MD' => 'Moldova',         'MC' => 'Monaco',         'MN' => 'Mongolia',         'ME' => 'Montenegro',         'MS' => 'Montserrat',         'MA' => 'Morocco',         'MZ' => 'Mozambique',         'MM' => 'Myanmar',         'NA' => 'Namibia',         'NR' => 'Nauru',         'NP' => 'Nepal',         'NL' => 'Netherlands',         'AN' => 'Netherlands Antilles',         'NC' => 'New Caledonia',         'NZ' => 'New Zealand',         'NI' => 'Nicaragua',         'NE' => 'Niger',         'NG' => 'Nigeria',         'NU' => 'Niue',         'NF' => 'Norfolk Island',         'MP' => 'Northern Mariana Islands',         'NO' => 'Norway',         'OM' => 'Oman',         'PK' => 'Pakistan',         'PW' => 'Palau',         'PS' => 'Palestinian Territory, Occupied',         'PA' => 'Panama',         'PG' => 'Papua New Guinea',         'PY' => 'Paraguay',         'PE' => 'Peru',         'PH' => 'Philippines',         'PN' => 'Pitcairn',         'PL' => 'Poland',         'PT' => 'Portugal',         'PR' => 'Puerto Rico',         'QA' => 'Qatar',         'RE' => 'Reunion',         'RO' => 'Romania',         'RU' => 'Russian Federation',         'RW' => 'Rwanda',         'BL' => 'Saint Barthelemy',         'SH' => 'Saint Helena',         'KN' => 'Saint Kitts And Nevis',         'LC' => 'Saint Lucia',         'MF' => 'Saint Martin',         'PM' => 'Saint Pierre And Miquelon',         'VC' => 'Saint Vincent And Grenadines',         'WS' => 'Samoa',         'SM' => 'San Marino',         'ST' => 'Sao Tome And Principe',         'SA' => 'Saudi Arabia',         'SN' => 'Senegal',         'RS' => 'Serbia',         'SC' => 'Seychelles',         'SL' => 'Sierra Leone',         'SG' => 'Singapore',         'SK' => 'Slovakia',         'SI' => 'Slovenia',         'SB' => 'Solomon Islands',         'SO' => 'Somalia',         'ZA' => 'South Africa',         'GS' => 'South Georgia And Sandwich Isl.',         'ES' => 'Spain',         'LK' => 'Sri Lanka',         'SD' => 'Sudan',         'SR' => 'Suriname',         'SJ' => 'Svalbard And Jan Mayen',         'SZ' => 'Swaziland',         'SE' => 'Sweden',         'CH' => 'Switzerland',         'SY' => 'Syrian Arab Republic',         'TW' => 'Taiwan',         'TJ' => 'Tajikistan',         'TZ' => 'Tanzania',         'TH' => 'Thailand',         'TL' => 'Timor-Leste',         'TG' => 'Togo',         'TK' => 'Tokelau',         'TO' => 'Tonga',         'TT' => 'Trinidad And Tobago',         'TN' => 'Tunisia',         'TR' => 'Turkey',         'TM' => 'Turkmenistan',         'TC' => 'Turks And Caicos Islands',         'TV' => 'Tuvalu',         'UG' => 'Uganda',         'UA' => 'Ukraine',         'AE' => 'United Arab Emirates',         'UM' => 'United States Outlying Islands',         'UY' => 'Uruguay',         'UZ' => 'Uzbekistan',         'VU' => 'Vanuatu',         'VE' => 'Venezuela',         'VN' => 'Viet Nam',         'VG' => 'Virgin Islands, British',         'VI' => 'Virgin Islands, U.S.',         'WF' => 'Wallis And Futuna',         'EH' => 'Western Sahara',         'YE' => 'Yemen',         'ZM' => 'Zambia',         'ZW' => 'Zimbabwe',     );
}

function language_capability() {
    return array('select'=>'Select','NONVERBAL'=>'Non-Verbal','NONVERBALSIGN'=>'Non-Verbal Uses Sign','VERDIFF'=>'Verbal with Difficulty','VERDIFFOUT'=>'Verbal without Difficulty','NONVERSTRESS'=>'Non-Verbal when Stressed',);
}

function diagnosis(){
    return array('Alzheimers'=>'Alzheimers','Amylotropic Sclerosis ALS'=>'Amylotropic Sclerosis ALS','Anxiety'=>'Anxiety','Aspergers'=>'Aspergers','Ataxia'=>'Ataxia','Autism High Functioning'=>'Autism High Functioning','Autism Low Functioning'=>'Autism Low Functioning','Bipolar'=>'Bipolar','Brain Injury'=>'Brain Injury','Cerebral Palsy'=>'Cerebral Palsy','Dementia'=>'Dementia','Down’s Syndrome'=>'Down’s Syndrome','Huntington’s Disease'=>'Huntington’s Disease','Multiple Sclerosis'=>'Multiple Sclerosis','Obsessive Compulsive Disorder'=>'Obsessive Compulsive Disorder','Oppositional Defiant Disorder'=>'Oppositional Defiant Disorder','Other'=>'Other','Parkinson’s Disease'=>'Parkinson’s Disease','Persuasive Developmental Delay'=>'Persuasive Developmental Delay','Post Traumatic Stress Disorder'=>'Post Traumatic Stress Disorder','Stroke'=>'Stroke','Touretts'=>'Touretts');
}

function iq_delay_degree(){
    return array('UNKNOWN'=>'Unknown','LESS60'=>'Less than 60','G60LES100'=>'60 and Less than 100','GREATER100'=>'Greater Than 100',);
}

function typical_response_being_approached(){
    return array('select'=>'Select','COOP'=>'Cooperative','UNCOOP'=>'Un-Cooperative','WITHDRAWN'=>'Withdrawn','COMABT'=>'Combative','LOUD'=>'Loud',);
}

function how_did_you_hear(){
    return array('select'=>'Select','Website'=>'Website','Google'=>'Google','Advertising'=>'Advertising','Friend'=>'Friend','Relative'=>'Relative' );
}

function contact_type(){
    return array('select'=>'','Primary Contact'=>'Primary Contact','Secondary Contact'=>'Secondary Contact','Emergency Contact'=>'Emergency Contact','Third Contact'=>'Third Contact','Fourth Contact'=>'Fourth Contact','Fifth Contact'=>'Fifth Contact');
}

function relationship_to_member(){  
    return array('Father'=>'Father', 'Mother'=>'Mother', 'Husband'=>'Husband', 'Wife'=>'Wife', 'Grandparent'=>'Grandparent', 'Guardian'=>'Guardian', 'Stepfather'=>'Stepfather', 'Stepmother'=>'Stepmother', 'Son'=>'Son', 'Daughter'=>'Daughter', 'Grandson'=>'Grandson', 'Granddaughter'=>'Granddaughter', 'OtherRelative'=>'OtherRelative', 'Friend'=>'Friend');
}




add_action('template_redirect', 'hms_redirect_non_logged_in');

function hms_redirect_non_logged_in() {
    $hms_admin_settings = get_option('hms_admin_settings');
    $non_loggedin_redirect = isset($hms_admin_settings['non_loggedin_redirect']) ? $hms_admin_settings['non_loggedin_redirect'] : '';
    if ( !is_user_logged_in()  && !is_page($non_loggedin_redirect)) {
        wp_redirect( site_url($non_loggedin_redirect.'?m=not_loggedin') );
        exit;
    }
}

add_action('template_redirect', 'hms_redirect_logged_in_user');

function hms_redirect_logged_in_user() { 

    $hms_admin_settings = get_option('hms_admin_settings');
$dashboard_link = isset($hms_admin_settings['dashboard_link']) ? $hms_admin_settings['dashboard_link'] : '';

 

    if (is_user_logged_in() && !is_page($dashboard_link)) { 
        wp_redirect(site_url($dashboard_link));
        exit; // Make sure to call exit after redirect
    }
}


function initialize_current_user() {
    global $current_user;
    wp_get_current_user();
    if ($current_user && isset($current_user->ID)) {
        $authorID = $current_user->ID;
    } else {
        $authorID = null; // Handle this case as needed
    }
}

/**
 * REGISTRATION PROCEDURE
 */
// Add action for AJAX registration
add_action('wp_ajax_nopriv_hms_register', 'hms_register');
add_action('wp_ajax_hms_register', 'hms_register');

function hms_register() {
    
    // Check nonce for security
    check_ajax_referer('hms_register_nonce', 'hms_register_nonce');

    // Initialize response
    $response = array();

    // Validate required fields
    $required_fields = array('first_name', 'last_name', 'address', 'city', 'state', 'date_of_birth', 'contact', 'gender', 'relationship', 'user_email', 'user_password');
    foreach ($required_fields as $field) {
        if (empty($_POST[$field])) {
            $response['error'] = true;
            $response['message'] = ucfirst($field) . ' is required.';
            echo json_encode($response);
            wp_die();
        }
    }

    // Email validation
    if (!filter_var($_POST['user_email'], FILTER_VALIDATE_EMAIL)) {
        $response['error'] = true;
        $response['message'] = 'Please enter a valid email address.';
        echo json_encode($response);
        wp_die();
    }

    // Check if email already exists
    if (email_exists($_POST['user_email'])) {
        $response['error'] = true;
        $response['message'] = 'This email is already registered.';
        echo json_encode($response);
        wp_die();
    }

    // Register user
    $userdata = array(
        'first_name' => sanitize_text_field($_POST['first_name']),
        'last_name' => sanitize_text_field($_POST['last_name']),
        'user_login' => sanitize_user($_POST['first_name']),
        'user_email' => sanitize_email($_POST['user_email']),
        'user_pass'  => $_POST['user_password'],
    );

    $user_id = wp_insert_user($userdata);

    if (!is_wp_error($user_id)) {
        // Add user meta data
        update_user_meta($user_id, 'address', sanitize_text_field($_POST['address']));
        update_user_meta($user_id, 'city', sanitize_text_field($_POST['city']));
        update_user_meta($user_id, 'state', sanitize_text_field($_POST['state']));
        update_user_meta($user_id, 'date_of_birth', sanitize_text_field($_POST['date_of_birth']));
        update_user_meta($user_id, 'contact', sanitize_text_field($_POST['contact']));
        update_user_meta($user_id, 'gender', sanitize_text_field($_POST['gender']));
        update_user_meta($user_id, 'relationship', sanitize_text_field($_POST['relationship']));
        update_user_meta($user_id, 'work_no', sanitize_text_field($_POST['work_no']));

        $response['success'] = true;
        $response['message'] = '<p>Registration successful.<br/> You can login <a href="'.site_url().'/user-login">Here</a> using your email/username and password.</p>';
    } else {
        $response['error'] = true;
        $response['message'] = $user_id->get_error_message();
    }

    echo json_encode($response);
    wp_die();
}




/***
 * USER PROFILE HMS FIELDS IN WP ADMIN
 * ***/

 function hms_user_profile_fields($user){?>
<div class="hms-admin-wrap">
    <h3><?php _e("HMS User Information", "hms");?></h3>

    <?php $user_id = $user->ID;   
    $first_name = get_user_meta($user_id, 'first_name', true);
$last_name = get_user_meta($user_id, 'last_name', true);
$address = get_user_meta($user_id, 'address', true);
$city = get_user_meta($user_id, 'city', true);
$state = get_user_meta($user_id, 'state', true);
$date_of_birth = get_user_meta($user_id, 'date_of_birth', true);
$contact = get_user_meta($user_id, 'contact', true);
$gender = get_user_meta($user_id, 'gender', true);
$relationship = get_user_meta($user_id, 'relationship', true);
$work_no = get_user_meta($user_id, 'work_no', true);?>
    <div class="row">
        <div class="col-12">

            <hr />
            <div class="">&nbsp</div>
            <table class="table form-table hms-table">
                <tr>
                    <td><label class="control-label text-right" for="fullname">Full name <span
                                class="text-danger">*</span></label></td>
                    <td>
                        <input class="form-control half" type="text" id="first_name" name="first_name"
                            value="<?php echo $first_name; ?>" placeholder="First name" />

                        <input class="form-control half" type="text" id="last_name" name="last_name"
                            value="<?php echo $last_name; ?>" placeholder="Last name" />
                    </td>
                </tr>
                <tr>
                    <td><label class="control-label text-right" for="address">Address <span
                                class="text-danger">*</span></label></td>
                    <td><textarea id="address" name="address" class="form-control"><?php echo $address ?></textarea>
                    </td>
                </tr>
                <tr>
                    <td><label class="control-label text-right" for="city">city <span
                                class="text-danger">*</span></label>
                    </td>
                    <td><input class="form-control" type="text" id="city" name="city" value="<?php echo $city; ?>" />
                    </td>
                </tr>


                <tr>
                    <td>
                        <label class="control-label text-right" for="state">
                            state<span class="text-danger">*</span>
                        </label>
                    </td>
                    <td>
                        <select name="state" id="state" class="form-control">
                            <option value="">---Select---</option>
                            <?php $states = us_states();?>
                            <?php foreach ($states as $single_state): ?>
                            <option value="<?php echo $single_state; ?>"
                                <?php if ($single_state == $state) echo 'selected="selected"'; ?>>
                                <?php echo $single_state; ?>
                            </option>
                            <?php endforeach; ?>
                        </select>
                    </td>

                </tr>

                <tr>
                    <td><label class="control-label text-right" for="date_of_birth">
                            Date of Birth:
                            <span class="text-danger">*</span></label>
                    </td>
                    <td>


                        <input type="text" name="date_of_birth" id="date_of_birth"
                            value="<?php echo  $date_of_birth ;?>" class="form-control" />

                    </td>
                </tr>
                <tr>
                    <td><label class="control-label text-right" for="contact">Contact No.<span
                                class="text-danger">*</span></label></td>
                    <td><input class="form-control" type="text" id="contact" name="contact"
                            value="<?php echo $contact;?>" /></td>
                </tr>

                <tr>
                    <td><label class="control-label text-right" for="male">Gender:</label></td>
                    <td><label class="radio-inline">
                            <input type="radio" class="" id="male" value="male" name="gender"
                                <?php if($gender == 'male'):?>checked="checked" <?php endif;?> />
                            Male
                        </label> &nbsp;&nbsp;
                        <label class="radio-inline">
                            <input type="radio" class="" id="female" value="female" name="gender"
                                <?php if($gender == 'female'):?>checked="checked" <?php endif;?> />
                            Female</label>
                    </td>
                </tr>
                <tr>
                    <td><label class="control-label text-right" for="relationship">Relationship to Member <span
                                class="text-danger">*</span></label></td>
                    <td>
                        <select name="relationship" id="relationship" class="form-control">
                            <option value="">---Select---</option>
                            <?php $relationships = relationship_to_member(); ?>
                            <?php foreach ($relationships as $single_relationship): ?>
                            <option value="<?php echo $single_relationship; ?>"
                                <?php if ($relationship == $single_relationship) echo 'selected="selected"'; ?>>
                                <?php echo $single_relationship; ?>
                            </option>
                            <?php endforeach; ?>
                        </select>
                    </td>
                </tr>

                <tr>
                    <td><label class="control-label text-right" for="work_no">Work No.</label></td>
                    <td><input class="form-control" type="text" id="work_no" name="work_no"
                            value="<?php echo $work_no;?>" />
                    </td>
                </tr>

            </table>


        </div>
    </div>
</div>
<?php
    }
    
    add_action('show_user_profile', 'hms_user_profile_fields');
    add_action('edit_user_profile', 'hms_user_profile_fields');
    
   
/***
 * SAVING USER PROFILE HMS FIELDS IN WP ADMIN
 * ***/
    function save_hms_user_profile_fields($user_id)
    {
     
        if (!current_user_can('edit_user', $user_id)) {
            return false;
        }
            $name = $_POST['first_name'].' '.$_POST['last_name'];
            $first_name = $_POST['first_name'];
            $last_name = $_POST['last_name'];
        $email = $_POST['user_email'];
        $password = $_POST['user_password'];
        $address = $_POST['address'];
        $city = $_POST['city'];
        $state = $_POST['state'];
    
        $date_of_birth = $_POST['date_of_birth'];
        
        $contact = $_POST['contact'];
        $gender = $_POST['gender'];
        $relationship = $_POST['relationship'];
        $work_no = $_POST['work_no'];
      
        update_user_meta($user_id, 'first_name', $first_name);
        update_user_meta($user_id, 'last_name', $last_name);
        update_user_meta($user_id, 'fullname', $name);
        update_user_meta($user_id, 'city', $city);
        update_user_meta($user_id, 'address', $address);
        update_user_meta($user_id, 'state', $state);
        update_user_meta($user_id, 'date_of_birth', $date_of_birth);
        update_user_meta($user_id, 'contact', $contact);
        update_user_meta($user_id, 'gender', $gender);
        update_user_meta($user_id, 'relationship', $relationship);
        update_user_meta($user_id, 'work_no', $work_no);
        update_user_meta($user_id, 'date_of_birth', $date_of_birth);

    
    }
    
    add_action('personal_options_update', 'save_hms_user_profile_fields');
    add_action('edit_user_profile_update', 'save_hms_user_profile_fields');
    